---
layout: post
title: Kotlin 범위지정 함수(apply, with, also, let, run)
author: Bong5
categories: [Keywords, Programing_Language/Kotlin]
--- 

## 범위지정 함수

---

### apply, with, let, also, run

위와 같은 함수들을 `범위 지정 함수`라고 한다.

위 함수들은 `전달받는 인자`와 `작동 방식`, `결과`가 매우 비슷하기 때문에 많은 경우에 서로를 대체해서 사용이 가능하다.

**범위 지정 함수**들은 `두 가지`의 구성 요소를 갖는다.

- **수신 객체**
- **수신 객체 지정 람다(`lambda with receiver`), 코드블럭(block)**

```kotlin
// with의 정의, 여기서 T.()는 `T의 확장 함수`
// 수신 객체 `receiver`의 확장함수 `block` 실행 결과를 반환
inline fun<T, R> with(receiver: T, block: T.() -> R) : R {
	return receiver.block()
}

// also는 T의 확장함수 형태
inline fun<T, R> T.also(block: (T) -> Unit): T {
	block(this) // this는 T의 (인스턴스를 가리키는)셀프참조
  return this
}
```

위의 범위 지정 함수 `with`의 정의를 살펴보면 `receiver`가 **수신 객체**, `block`이 **수신 객체 지정 람다**에 해당한다.

아래의 예제 코드는 사용 예다.

```kotlin
class Person {
	var name: String? = null
	var age: Int? = null
}

// 일반 코드
val person: Person = getPerson()
print(person.name)
print(person.age)

// 범위 지정 함수 with 사용 코드
val person : Person = getPerson()
with(person) {
	print(name)
	print(age)
}

// 범위 지정 함수 also 사용 코드
val person: Person = getPerson().also { thisPerson -> 
	println(thisPerson.name)
	println(thisPerson.age)
}
```

<img src="/assets/img/kotlin/applylet.GIF" width="80%" height="auto" >

### 5가지 범위 지정 함수의 정의

```kotlin
inline fun <T, R> with(receiver: T, block: T.() -> R): R {
    return receiver.block()
}

inline fun <T> T.also(block: (T) -> Unit): T {
    block(this)
    return this
}

inline fun <T> T.apply(block: T.() -> Unit): T {
    block()
    return this
}

inline fun <T, R> T.let(block: (T) -> R): R {
    return block(this)
}

inline fun <T, R> T.run(block: T.() -> R): R {
    return block()
}
```

## 각 함수의 사용 규칙(공식 문서 권장)

### apply

수신 객체 람다(`block: T.() → Unit`) 내부에서 수신 객체의 함수(`T.someFunc()`)를 사용하지 않고 수신 객체 자신(`T 타입의 인스턴스`)를 다시 반환하려는 경우에 사용

**수신 객체의 프로퍼티만을 사용하는 대표적인 경우가 `객체의 초기화`**

```kotlin
// apply 사용 코드
val peter = Person().apply {
	name = "Peter"
	age = 18
}

// 일반 코드
val peter = Person()
peter.name = "Peter"
peter.age = 18
```

### also

수신 객체 람다(`block: (T) → Unit`)가 **수신 객체(`T`)를 전혀 사용하지 않거나 수신 객체의 속성을 변경하지 않고 사용하는 경우에 사용**

`객체의 사이드 이펙트 확인`, 수신 객체의 데이터 유효성 검사시에 유용

```kotlin
// also 사용 코드
class Book(author: Person) {
	val author = author.also {
		requireNotNull(it.age)
		println(it.name)
	}
}

// 일반 코드
class Book(val author: Person) {
	init {
		requireNotNull(author.age)
		println(author.name)
	}
}
```

### let

- 지정된 값이 `null`이 아닌 경우에만 코드를 실행해야 하는 경우.
- `Nullable` 객체를 다른 `Nullable` 객체로 변환하는 경우.
- 단일 지역 변수의 범위를 제한하는 경우.

```kotlin
getNullablePerson()?.let {
	// null이 아닐 때만 실행된다.
	promote(it)
}

val driversLicence: Licence? = getNullablePerson()?.let {
	// nullable personal 객체를 nullable driversLicence 객체로 변경
	licenceService.getDriversLicence(it)
}

val person: Person = getPerson()
getPersonDao().let { 
	// 변수 dao의 범위는 이 블럭내부로 제한
	dao -> dao.insert(person) 
}
```

`let`을 사용하지 않는 동일한 코드는 아래와 같다.

```kotlin
val person: Person? = getPromotablePerson()
if (person != null ) {
	promote(person)
}

val driver: Person? = getDriver()
val driversLicence: Licence? = if (driver == null) null else licenceService.getDriverLicence(it)

val person: Person() = getPerson()
val personDao: personDao = getPersonDao()
personDao.insert(person)
```

### with

`Non-nullable`(Null이 될 수 없는) 수신 객체이고, 결과가 필요하지 않은 경우에 사용

```kotlin
// with 사용 코드
val person: Person = Person()
with(person) {
	print(name)
	print(age)
}

// 일반 코드
val person: Person = Person()
print(person.name)
print(person.age)
```

### run

어떤 값을 계산할 필요가 있거나 지역 변수 여러개의 범위를 제한할 때 `run`을 사용한다.

매개 변수로 전달된 `명시적 수신 객체`를 `암시적 수신 객체`로 변환할 때도 사용할 수 있다.

```kotlin
val inserted: Boolean = run {
	// person과 personDao의 범위 제한
	val person: Person = getPerson()
	val personDao: PersonDao = getPersonDao()

	//수행 결과 반환
	personDao.insert(person)
}

fun printAge(person: Person) = person.run {
	// person을 수신 객체로 변환하여 age 값을 사용.
	print(age)
}
```

`run`을 사용하지 않는 동일한 코드는 아래와 같다.

```kotlin
val person: Person = getPerson()
val personDao: PersonDao = getPersonDao()
val insterted: Boolean = personDao.insert(person)

fun printAge(person: Person) =  {
	print(person.age)
}
```